/*
 *  rune.c
 *
 *  Runes (Unicode code points) support for Ciao
 *
 *  Copyright (C) 2020 Jose F. Morales, The Ciao Development Team
 */

#include <stdio.h>
#include <stdint.h>

#include <ciao/termdefs.h> /* c_rune_t */

/* Autogenerated Unicode tables (see unicode_gen.pl) */
#include <ciao/unicode_tbl.h>

/* --------------------------------------------------------------------------- */
/* Rune table */

char runelowtbl[256];

void init_runetbl(void) {
  c_rune_t i;
  char *cp;

  for (i=0; i<128; i++) runelowtbl[i] = 0; /* default: whitespace */
  for (i=128; i<256; i++) runelowtbl[i] = 6; /* special case for UTF8 */
  
  for (cp="abcdefghijklmnopqrstuvwxyz"; (i = *cp++); )
    runelowtbl[i]=1;            /* lowercase */
  for (cp="ABCDEFGHIJKLMNOPQRSTUVWXYZ_"; (i = *cp++); )
    runelowtbl[i]=2;            /* uppercase */
  for (cp="0123456789"; (i = *cp++); )
    runelowtbl[i]=3;            /* digits */
  for (cp="#$&*+-./:<=>?@^\\`~"; (i = *cp++); )
    runelowtbl[i]=4;            /* symbolchars */
  for (cp="!;\"'%(),[]{|}"; (i = *cp++); )
    runelowtbl[i]=5;            /* punctuation */
}

/* --------------------------------------------------------------------------- */

static inline int range_left(int i) {
  return ranges[i]&((1<<VAL_SHIFT)-1);
}
static inline int range_val(int i) {
  return ranges[i]>>VAL_SHIFT;
}

/* Dichotomic search the class of rune `c` in the ranges array
   (requires around log2(RANGES_COUNT)=11 iterations) */
int rune_lookup_class(int c) {
  if (c>=MAX_RUNE) return 0;
  int min = 0;
  int max = RANGES_COUNT;
  int block = c/BLOCK_ELEMS;
  int offset = c&(BLOCK_ELEMS-1);
  int i;
  while(1) {
    i=(max+min)/2; // mid point
    // printf("%d %d %d\n", min, i, max);
    if (i == min) break;
    if (block < range_left(i)) max=i; else min=i;
  };
  return (dict[range_val(i)]>>(offset*CLBITS))&((1<<CLBITS)-1);
}
